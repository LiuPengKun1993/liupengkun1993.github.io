<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>iOS开发之源码解析 - MBProgressHUD - liupengkun</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="liupengkun" />
  <meta name="description" content="MBProgressHUD 是一个为 APP 添加 HUD 窗口的第三方框架，使用起来极其简单方便，关于 MBProgressHUD 的使用方法，GitHub 上有详细的说明，这里就不多加介绍了，本文主要是从源码" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.79.0" />


<link rel="canonical" href="http://liupengkun1993.github.io/post/ios/ios%E5%BC%80%E5%8F%91%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-mbprogresshud/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.f1e506a781bf25d33ffc18aa6b4e972a965c58049d27d4f92b7db2e9bf28e4bf.css" integrity="sha256-8eUGp4G/JdM//Biqa06XKpZcWASdJ9T5K32y6b8o5L8=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="iOS开发之源码解析 - MBProgressHUD" />
<meta property="og:description" content="MBProgressHUD 是一个为 APP 添加 HUD 窗口的第三方框架，使用起来极其简单方便，关于 MBProgressHUD 的使用方法，GitHub 上有详细的说明，这里就不多加介绍了，本文主要是从源码" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://liupengkun1993.github.io/post/ios/ios%E5%BC%80%E5%8F%91%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-mbprogresshud/" />
<meta property="article:published_time" content="2017-02-28T15:43:48+08:00" />
<meta property="article:modified_time" content="2017-12-22T15:43:48+08:00" />
<meta itemprop="name" content="iOS开发之源码解析 - MBProgressHUD">
<meta itemprop="description" content="MBProgressHUD 是一个为 APP 添加 HUD 窗口的第三方框架，使用起来极其简单方便，关于 MBProgressHUD 的使用方法，GitHub 上有详细的说明，这里就不多加介绍了，本文主要是从源码">
<meta itemprop="datePublished" content="2017-02-28T15:43:48+08:00" />
<meta itemprop="dateModified" content="2017-12-22T15:43:48+08:00" />
<meta itemprop="wordCount" content="9251">



<meta itemprop="keywords" content="iOS,源码解析," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="iOS开发之源码解析 - MBProgressHUD"/>
<meta name="twitter:description" content="MBProgressHUD 是一个为 APP 添加 HUD 窗口的第三方框架，使用起来极其简单方便，关于 MBProgressHUD 的使用方法，GitHub 上有详细的说明，这里就不多加介绍了，本文主要是从源码"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">liupengkun'Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      liupengkun'Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://liupengkun1993.github.io/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">iOS开发之源码解析 - MBProgressHUD</h1>
      
      <div class="post-meta">
        <time datetime="2017-02-28" class="post-time">
          2017-02-28
        </time>
        <div class="post-category">
            <a href="http://liupengkun1993.github.io/categories/ios/"> iOS </a>
            
          </div>
        <span class="more-meta"> 9251 words </span>
          <span class="more-meta"> 19 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#一mbprogresshud-核心-api">一、MBProgressHUD 核心 API</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#二show-系列方法">二、show 系列方法</a></li>
    <li><a href="#三hide-系列方法">三、hide 系列方法</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <blockquote>
<p><a href="https://github.com/jdg/MBProgressHUD">MBProgressHUD</a> 是一个为 <code>APP</code> 添加 <code>HUD</code> 窗口的第三方框架，使用起来极其简单方便，关于 <code>MBProgressHUD</code> 的使用方法，<code>GitHub</code> 上有详细的说明，这里就不多加介绍了，本文主要是从源码的角度分析 <code>MBProgressHUD</code>的具体实现。</p>
</blockquote>
<ul>
<li>先来对 <a href="https://github.com/jdg/MBProgressHUD">MBProgressHUD</a> 有个大体的认识，这是刚从 <code>GitHub</code> 上拉下来的代码，如下图，MBProgressHUD 的主要文件只有两个：
<!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD01.jpg" alt=""></p>
<hr>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<p>下面我们就开始分析 <a href="https://github.com/jdg/MBProgressHUD">MBProgressHUD</a> 的具体实现。在此之前先了解下文章的目录，本文主要有三个部分：</p>
<ol>
<li><strong>MBProgressHUD 核心 API</strong></li>
</ol>
<ul>
<li>这一部分讲的主要是 MBProgressHUD 的一些属性方法等，主要是为了对 MBProgressHUD 先有个大概的认识</li>
</ul>
<ol start="2">
<li><strong>show 系列方法</strong></li>
</ol>
<ul>
<li>这一部分主要是展示 HUD 窗口时调用的方法及代码分析</li>
</ul>
<ol start="3">
<li><strong>hide 系列方法</strong></li>
</ol>
<ul>
<li>这一部分主要是隐藏 HUD 窗口时调用的方法及代码分析</li>
</ul>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="一mbprogresshud-核心-api">一、MBProgressHUD 核心 API</h2>
<blockquote>
<p>这一部分讲的主要是 MBProgressHUD 的一些属性方法等，主要是为了对 MBProgressHUD 先有个大概的认识</p>
</blockquote>
<h4 id="11-模式">1.1 模式</h4>
<p>首先来看看 <a href="https://github.com/jdg/MBProgressHUD">MBProgressHUD</a> 中定义的枚举，<code>mode </code> 一共有六种显示样式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 显示样式
</span><span class="c1"></span><span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">,</span> <span class="n">MBProgressHUDMode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">/// 默认模式, 系统自带的指示器
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeIndeterminate</span><span class="p">,</span>
    <span class="c1">/// 圆形饼图
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeDeterminate</span><span class="p">,</span>
    <span class="c1">/// 水平进度条
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeDeterminateHorizontalBar</span><span class="p">,</span>
    <span class="c1">/// 圆环
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeAnnularDeterminate</span><span class="p">,</span>
    <span class="c1">/// 自定义视图
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeCustomView</span><span class="p">,</span>
    <span class="c1">/// 只显示文字
</span><span class="c1"></span>    <span class="n">MBProgressHUDModeText</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>简单的效果图如下（颜色尺寸等都可以优化，我这里只是简单地示例）：</p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD02.gif" alt="默认模式：hud.mode = MBProgressHUDModeIndeterminate"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD03.gif" alt="圆形饼图：hud.mode = MBProgressHUDModeDeterminate"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD04.gif" alt="水平进度条：hud.mode = MBProgressHUDModeDeterminateHorizontalBar"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD05.gif" alt="圆环：hud.mode = MBProgressHUDModeAnnularDeterminate"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD06.gif" alt="自定义视图：hud.mode = MBProgressHUDModeCustomView"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD07.gif" alt="只显示文字：hud.mode = MBProgressHUDModeText"></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="12-动画效果">1.2 动画效果</h4>
<p>MBProgressHUD 在显示 HUD 窗口的时候，一般都伴随着动画效果，MBProgressHUD 中的动画效果也是一个枚举，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">,</span> <span class="n">MBProgressHUDAnimation</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">///  默认效果，只有透明度变化
</span><span class="c1"></span>    <span class="n">MBProgressHUDAnimationFade</span><span class="p">,</span>
    <span class="c1">/// 透明度变化 + 形变 (放大时出现缩小消失)
</span><span class="c1"></span>    <span class="n">MBProgressHUDAnimationZoom</span><span class="p">,</span>
    <span class="c1">/// 透明度变化 + 形变 (缩小)
</span><span class="c1"></span>    <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">,</span>
    <span class="c1">/// 透明度变化 + 形变 (放大)
</span><span class="c1"></span>    <span class="n">MBProgressHUDAnimationZoomIn</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><em>这里先简单的罗列出来，下文中还会多次用到。</em>
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="13-mbprogresshud-组成">1.3 MBProgressHUD 组成</h4>
<p><code>MBProgressHUD</code> 主要由四部分组成：<strong>loading 动画视图</strong>、<strong>标题文本框</strong>、<strong>详情文本框</strong>、<strong>HUD 背景框</strong>，如下图。</p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD08.gif" alt="MBProgressHUD 组成"></p>
<p>之前用 <code>MBProgressHUD</code> 设置标题文本详情文本是通过几个属性来实现的，功能少也较为繁琐，因此被遗弃了；现在设置标题文本详情文本等十分简便，直接通过 label 等控件就可以实现，而且在功能上也有很大的扩展，详情请看下面这个代码块：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// bezelView 是指包括文本和指示器的视图，和自定义的 customView 类似
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">bezelView</span><span class="p">;</span>
<span class="c1">/// backgroundView 背景视图
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">backgroundView</span><span class="p">;</span>
<span class="c1">/// customView 自定义视图
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="n">nullable</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">customView</span><span class="p">;</span>
<span class="c1">/// label 指的是标题文本
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
<span class="c1">/// detailsLabel指的是详情文本
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">detailsLabel</span><span class="p">;</span>
<span class="c1">/// hud 窗口还可以加入button，添加事件
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>另外这里再附加两张 <code>MBProgressHUD</code> 的整体布局图，以便更好地认识 <code>MBProgressHUD</code>。</p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD09.gif" alt="MBProgressHUD 的整体布局图 1"></p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD10.png" alt="MBProgressHUD 的整体布局图 2"></p>
<p><strong>简单介绍</strong>：</p>
<ul>
<li>backgroundView：整个背景图层，可以通过 MBBackgroundView 的 style 属性设置</li>
<li>bezelView：提供元素 （indicator、label、detailLabel、button）的背景</li>
<li>indicator：指示器显示进度情况 这个视图由我们设定的mode属性决定</li>
<li>label：显示标题文本</li>
<li>detailLabel：显示详情文本</li>
<li>button：添加点击事件
<!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<h4 id="14-mbprogresshud-中的属性">1.4 MBProgressHUD 中的属性</h4>
<p>MBProgressHUD 文件中主要包括四个类，它们分别是 <strong>MBProgressHUD</strong>、<strong>MBRoundProgressView</strong>、 <strong>MBBarProgressView</strong>、 <strong>MBBackgroundView</strong>。这四个类各有各的用法，比如如果是进度条模式(MBProgressHUDModeDeterminateHorizontalBar)，则使用的是 <code>MBBarProgressView</code> 类；如果是饼图模式(MBProgressHUDModeDeterminate)或环形模式(MBProgressHUDModeAnnularDeterminate)，则使用的是 <code>MBRoundProgressView </code>类。下面是这四个类的相关属性。</p>
<h6 id="141--mbprogresshud-相关属性">1.41  MBProgressHUD 相关属性</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// show 方法触发到显示 HUD 窗口的间隔时间，默认是 0
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">graceTime</span><span class="p">;</span>

<span class="c1">/// HUD 窗口显示的最短时间，默认是 0
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">NSTimeInterval</span> <span class="n">minShowTime</span><span class="p">;</span>

<span class="c1">/// HUD 窗口显示模式, 默认是系统自带的指示器
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">MBProgressHUDMode</span> <span class="n">mode</span><span class="p">;</span>

<span class="c1">/// 进度条指示器以及文本的颜色
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="n">nullable</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">contentColor</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// HUD 窗口显示和隐藏的动画类型MBProgressHUD
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">MBProgressHUDAnimation</span> <span class="n">animationType</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// HUD 窗口位置设置，比如 hud.offset = CGPointMake(0.f, MBProgressMaxOffset)，可以移到底部中心位置
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGPoint</span> <span class="n">offset</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// HUD 元素到 HUD 边缘的距离，默认是 20.f
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">margin</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// HUD 窗口背景框的最小尺寸
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGSize</span> <span class="n">minSize</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// 是否强制 HUD 背景框宽高相等
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">getter</span> <span class="o">=</span> <span class="n">isSquare</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">square</span> <span class="n">UI_APPEARANCE_SELECTOR</span><span class="p">;</span>

<span class="c1">/// 进度条 (0.0 到 1.0)
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">)</span> <span class="kt">float</span> <span class="n">progress</span><span class="p">;</span>

<span class="c1">/// bezelView 是指包括文本和指示器的视图，和自定义的 customView 类似
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">bezelView</span><span class="p">;</span>

<span class="c1">/// backgroundView 背景视图
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">backgroundView</span><span class="p">;</span>

<span class="c1">/// customView 自定义视图
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="n">nullable</span><span class="p">)</span> <span class="n">UIView</span> <span class="o">*</span><span class="n">customView</span><span class="p">;</span>

<span class="c1">/// label 指的是标题文本
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>

<span class="c1">/// detailsLabel指的是详情文本
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">detailsLabel</span><span class="p">;</span>

<span class="c1">/// hud 窗口还可以加入button，添加事件
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">,</span> <span class="k">readonly</span><span class="p">)</span> <span class="n">UIButton</span> <span class="o">*</span><span class="n">button</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="142-mbroundprogressview-相关属性">1.42 MBRoundProgressView 相关属性</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 进度条 (0.0 到 1.0)
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">)</span> <span class="kt">float</span> <span class="n">progress</span><span class="p">;</span>

<span class="c1">/// 进度条颜色
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">progressColor</span><span class="p">;</span>

<span class="c1">/// 进度条指示器的颜色
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">progressTintColor</span><span class="p">;</span>

<span class="c1">/// 进度条指示器的背景颜色，只适用在 iOS7 以上，默认为半透明的白色 (透明度 0.1)
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">backgroundTintColor</span><span class="p">;</span>

<span class="c1">/// 显示模式，NO = 圆形；YES = 环形。默认是 NO
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">,</span> <span class="k">getter</span> <span class="o">=</span> <span class="n">isAnnular</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">annular</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="143-mbbarprogressview-相关属性">1.43 MBBarProgressView 相关属性</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 进度条 (0.0 到 1.0)
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">)</span> <span class="kt">float</span> <span class="n">progress</span><span class="p">;</span>

<span class="c1">/// 进度条边界线的颜色，默认是白色
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">lineColor</span><span class="p">;</span>

<span class="c1">/// 进度条背景色，默认是透明
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">progressRemainingColor</span><span class="p">;</span>

<span class="c1">/// 进度条颜色
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">progressColor</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h6 id="144-mbbackgroundview-相关属性">1.44 MBBackgroundView 相关属性</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 背景图层样式，有两种，iOS7 或者以上版本默认风格是MBProgressHUDBackgroundStyleBlur，其他为MBProgressHUDBackgroundStyleSolidColor，由于 iOS7 不支持 UIVisualEffectView，所以在 iOS7 和更高版本中会有所不同
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">MBProgressHUDBackgroundStyle</span> <span class="n">style</span><span class="p">;</span>

<span class="c1">/// 背景颜色，由于 iOS7 不支持 UIVisualEffectView，所以在 iOS7 和更高版本中会有所不同
</span><span class="c1"></span><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="n">UIColor</span> <span class="o">*</span><span class="n">color</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h4 id="15-mbprogresshud-中的一些方法">1.5 MBProgressHUD 中的一些方法</h4>
<h6 id="151-类方法">1.51 类方法</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 创建一个 HUD 窗口，并把它显示在 view 上，还可以设置是否有动画
</span><span class="c1"></span><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">showHUDAddedTo:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">/// 找到最上层的 HUD subview 并把它隐藏，成功为YES、其他情况为 NO
</span><span class="c1"></span><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">hideHUDForView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">/// 返回最上层的 HUD subview
</span><span class="c1"></span><span class="p">+</span> <span class="p">(</span><span class="n">nullable</span> <span class="n">MBProgressHUD</span> <span class="o">*</span><span class="p">)</span><span class="nf">HUDForView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这三个类方法中，常用的是第一个函数<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated;</code>直接创建 HUD，并把它显示在 view 上，用起来极其方便</p>
<h6 id="152-对象方法">1.52 对象方法</h6>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 以view为基准创建初始化一个HUD对象，为HUD的初始化构造函数
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span><span class="p">;</span>

<span class="c1">/// 显示HUD控件，此函数应该在主线程中调用
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">/// 隐藏HUD控件，animated控制是否显示动画。对应于- (void)showAnimated:(BOOL)animated;
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">/// 在delay时间之后隐藏HUD，animated控制显示动画与否，delay控制延迟时间
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="nf">afterDelay:</span><span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">delay</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>这几个对象方法中，常用的也有两个<code>- (void)hideAnimated:(BOOL)animated;</code>和<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay;</code></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="二show-系列方法">二、show 系列方法</h2>
<blockquote>
<p>这一部分主要是展示 HUD 窗口时调用的方法及代码分析</p>
</blockquote>
<p>下面这个方法在我们创建 MBProgressHUD 对象时首先调用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">showHUDAddedTo:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>

	<span class="c1">/// 创建并初始化 MBProgressHUD 对象，根据传进来的 view 来设定
</span><span class="c1"></span>    <span class="n">MBProgressHUD</span> <span class="o">*</span><span class="n">hud</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithView</span><span class="p">:</span><span class="n">view</span><span class="p">];</span>
    
    <span class="c1">/// 移除 HUD 窗口
</span><span class="c1"></span>    <span class="n">hud</span><span class="p">.</span><span class="n">removeFromSuperViewOnHide</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    
    <span class="c1">/// 添加到 View 上，并显示
</span><span class="c1"></span>    <span class="p">[</span><span class="n">view</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">hud</span><span class="p">];</span>
    <span class="p">[</span><span class="n">hud</span> <span class="nl">showAnimated</span><span class="p">:</span><span class="n">animated</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">hud</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法会调用两个主要方法：<code>- (id)initWithView:(UIView *)view</code> 和 <code>- (void)showAnimated:(BOOL)animated</code>，具体的调用流程如下图：</p>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD11.png" alt="show 相关的方法调用"></p>
<p>当然在 MBProgressHUD 中，<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated</code> 调用的方法远不止上图列的这些，图上列的只是几个主要方法。接下来我们就根据程序的执行过程来一步一步分析一下代码。</p>
<p>在方法 <code>- (id)initWithView:(UIView *)view</code>中，调用 <code>- (instancetype)initWithFrame:(CGRect)frame</code>，接着会调用<code>- (void)commonInit</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="p">{</span>
    <span class="n">NSAssert</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="s">@&#34;View must not be nil.&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">initWithFrame</span><span class="p">:</span><span class="n">view</span><span class="p">.</span><span class="n">bounds</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithFrame:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">frame</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">initWithFrame</span><span class="p">:</span><span class="n">frame</span><span class="p">]))</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">commonInit</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithCoder:</span><span class="p">(</span><span class="n">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="nv">aDecoder</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">initWithCoder</span><span class="p">:</span><span class="n">aDecoder</span><span class="p">]))</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">commonInit</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">commonInit</span> <span class="p">{</span>

    <span class="c1">/// 默认效果, 透明度变化
</span><span class="c1"></span>    <span class="n">_animationType</span> <span class="o">=</span> <span class="n">MBProgressHUDAnimationFade</span><span class="p">;</span>
    
    <span class="c1">/// 默认模式, 系统自带的指示器
</span><span class="c1"></span>    <span class="n">_mode</span> <span class="o">=</span> <span class="n">MBProgressHUDModeIndeterminate</span><span class="p">;</span>
    
    <span class="c1">/// HUD 元素到 HUD 边缘的距离，默认是 20.f
</span><span class="c1"></span>    <span class="n">_margin</span> <span class="o">=</span> <span class="mf">20.0f</span><span class="p">;</span>
    <span class="n">_opacity</span> <span class="o">=</span> <span class="mf">1.f</span><span class="p">;</span>
    <span class="n">_defaultMotionEffectsEnabled</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>

    <span class="c1">// 默认颜色，根据当前的 iOS 版本
</span><span class="c1"></span>    <span class="kt">BOOL</span> <span class="n">isLegacy</span> <span class="o">=</span> <span class="n">kCFCoreFoundationVersionNumber</span> <span class="o">&lt;</span> <span class="n">kCFCoreFoundationVersionNumber_iOS_7_0</span><span class="p">;</span>
    
    <span class="c1">/// 进度条指示器以及文本的颜色
</span><span class="c1"></span>    <span class="n">_contentColor</span> <span class="o">=</span> <span class="n">isLegacy</span> <span class="o">?</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nl">colorWithWhite</span><span class="p">:</span><span class="mf">0.f</span> <span class="nl">alpha</span><span class="p">:</span><span class="mf">0.7f</span><span class="p">];</span>

	<span class="c1">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO
</span><span class="c1"></span>    <span class="nb">self</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    
    <span class="c1">/// 背景色
</span><span class="c1"></span>    <span class="nb">self</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
    
    <span class="c1">// 透明度为 0 
</span><span class="c1"></span>    <span class="nb">self</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
    <span class="c1">/// 自动调整子控件与父控件之间的宽高
</span><span class="c1"></span>    <span class="nb">self</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="o">=</span> <span class="n">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="n">UIViewAutoresizingFlexibleHeight</span><span class="p">;</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">allowsGroupOpacity</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>

	<span class="c1">/// 设置所需的子view
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="n">setupViews</span><span class="p">];</span>
    <span class="c1">/// 设置指示器样式
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="n">updateIndicators</span><span class="p">];</span>
    <span class="c1">/// 注册通知
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="n">registerForNotifications</span><span class="p">];</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>上面代码块中的代码已经加过注释，因此在这里不再累述某句代码有什么作用，这里直接说程序的执行流程。当程序执行到 <code>- (void)commonInit</code> 这个方法时，会相继执行<code>- (void)setupViews</code>，<code>- (void)updateIndicators</code>，<code>- (void)registerForNotifications</code> 这三个方法，当然在执行这三个方法期间，也会执行其它的方法，比如会执行<code>- (void)updateForBackgroundStyle</code> 和<code>- (void)updateBezelMotionEffects</code>等等，这和你设置的 mode 的模式，以及和 label，detailsLabel ，button 这一系列元素，以及和相应的属性都有一定的关系。</p>
<p>接着我们来分析一下 <code>- (void)setupViews</code>，<code>- (void)updateIndicators</code>，<code>- (void)registerForNotifications</code> 这三个方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setupViews</span> <span class="p">{</span>

	<span class="c1">/// 进度条指示器以及文本的颜色
</span><span class="c1"></span>    <span class="n">UIColor</span> <span class="o">*</span><span class="n">defaultColor</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">contentColor</span><span class="p">;</span>
    

	<span class="c1">/// 创建背景视图
</span><span class="c1"></span>    <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">backgroundView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MBBackgroundView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">];</span>
    
    <span class="c1">/// 背景图层样式
</span><span class="c1"></span>    <span class="n">backgroundView</span><span class="p">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">MBProgressHUDBackgroundStyleSolidColor</span><span class="p">;</span>
    <span class="n">backgroundView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
    
    <span class="c1">/// 自动调整 view 的宽度和高度
</span><span class="c1"></span>    <span class="n">backgroundView</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="o">=</span> <span class="n">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="n">UIViewAutoresizingFlexibleHeight</span><span class="p">;</span>
    <span class="n">backgroundView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">backgroundView</span><span class="p">];</span>
    <span class="n">_backgroundView</span> <span class="o">=</span> <span class="n">backgroundView</span><span class="p">;</span>

	<span class="c1">/// 创建背景视图（和上面那个大小不同）
</span><span class="c1"></span>    <span class="n">MBBackgroundView</span> <span class="o">*</span><span class="n">bezelView</span> <span class="o">=</span> <span class="p">[</span><span class="n">MBBackgroundView</span> <span class="n">new</span><span class="p">];</span>
    
    <span class="c1">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO
</span><span class="c1"></span>    <span class="n">bezelView</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">bezelView</span><span class="p">.</span><span class="n">layer</span><span class="p">.</span><span class="n">cornerRadius</span> <span class="o">=</span> <span class="mf">5.f</span><span class="p">;</span>
    <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">bezelView</span><span class="p">];</span>
    <span class="n">_bezelView</span> <span class="o">=</span> <span class="n">bezelView</span><span class="p">;</span>
    
    <span class="c1">/// 调用 updateBezelMotionEffects 方法，设置视差效果
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="n">updateBezelMotionEffects</span><span class="p">];</span>
    

	<span class="c1">/// 创建 label 标签，显示主要文本
</span><span class="c1"></span>    <span class="n">UILabel</span> <span class="o">*</span><span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="n">UILabel</span> <span class="n">new</span><span class="p">];</span>
    
    <span class="c1">/// 取消文字大小自适应
</span><span class="c1"></span>    <span class="n">label</span><span class="p">.</span><span class="n">adjustsFontSizeToFitWidth</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">label</span><span class="p">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="n">NSTextAlignmentCenter</span><span class="p">;</span>
    <span class="n">label</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="n">defaultColor</span><span class="p">;</span>
    <span class="n">label</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">boldSystemFontOfSize</span><span class="p">:</span><span class="n">MBDefaultLabelFontSize</span><span class="p">];</span>
    
    <span class="c1">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO
</span><span class="c1"></span>    <span class="n">label</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">label</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
    <span class="n">_label</span> <span class="o">=</span> <span class="n">label</span><span class="p">;</span>
	
	
	<span class="c1">/// 创建 detailsLabel 标签，显示详细信息
</span><span class="c1"></span>	
    <span class="n">UILabel</span> <span class="o">*</span><span class="n">detailsLabel</span> <span class="o">=</span> <span class="p">[</span><span class="n">UILabel</span> <span class="n">new</span><span class="p">];</span>
    <span class="c1">/// 取消文字大小自适应
</span><span class="c1"></span>    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">adjustsFontSizeToFitWidth</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="n">NSTextAlignmentCenter</span><span class="p">;</span>
    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="n">defaultColor</span><span class="p">;</span>
    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">numberOfLines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">boldSystemFontOfSize</span><span class="p">:</span><span class="n">MBDefaultDetailsLabelFontSize</span><span class="p">];</span>
    
    <span class="c1">/// opaque 类似 Alpha，表示当前 UIView 的不透明度，设置是否之后对于 UIView 的显示并没有什么影响,官方文档的意思是 opaque 默认为 YES，如果 alpha 小于 1，那么应该设置 opaque 设置为 NO，当 alpha 为 1，opaque设置为 NO
</span><span class="c1"></span>    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">opaque</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">detailsLabel</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">];</span>
    <span class="n">_detailsLabel</span> <span class="o">=</span> <span class="n">detailsLabel</span><span class="p">;</span>
    

	<span class="c1">/// 创建 button 按钮，并添加响应按钮
</span><span class="c1"></span>    <span class="n">UIButton</span> <span class="o">*</span><span class="n">button</span> <span class="o">=</span> <span class="p">[</span><span class="n">MBProgressHUDRoundedButton</span> <span class="nl">buttonWithType</span><span class="p">:</span><span class="n">UIButtonTypeCustom</span><span class="p">];</span>
    <span class="n">button</span><span class="p">.</span><span class="n">titleLabel</span><span class="p">.</span><span class="n">textAlignment</span> <span class="o">=</span> <span class="n">NSTextAlignmentCenter</span><span class="p">;</span>
    <span class="n">button</span><span class="p">.</span><span class="n">titleLabel</span><span class="p">.</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="nl">boldSystemFontOfSize</span><span class="p">:</span><span class="n">MBDefaultDetailsLabelFontSize</span><span class="p">];</span>
    <span class="p">[</span><span class="n">button</span> <span class="nl">setTitleColor</span><span class="p">:</span><span class="n">defaultColor</span> <span class="nl">forState</span><span class="p">:</span><span class="n">UIControlStateNormal</span><span class="p">];</span>
    <span class="n">_button</span> <span class="o">=</span> <span class="n">button</span><span class="p">;</span>
	
	
	<span class="c1">/// 将 label，detailLabel，button 添加到蒙版视图
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="n">view</span> <span class="k">in</span> <span class="l">@[</span><span class="n">label</span><span class="p">,</span> <span class="n">detailsLabel</span><span class="p">,</span> <span class="n">button</span><span class="l">]</span><span class="p">)</span> <span class="p">{</span>
    
    	<span class="c1">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO
</span><span class="c1"></span>        <span class="n">view</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        
        <span class="c1">/// 为视图设置水平方向上优先级为 998 的压缩阻力
</span><span class="c1"></span>        <span class="p">[</span><span class="n">view</span> <span class="nl">setContentCompressionResistancePriority</span><span class="p">:</span><span class="mf">998.f</span> <span class="nl">forAxis</span><span class="p">:</span><span class="n">UILayoutConstraintAxisHorizontal</span><span class="p">];</span>
        
        <span class="c1">/// 为视图设置垂直方向上优先级为 998 的压缩阻力
</span><span class="c1"></span>        <span class="p">[</span><span class="n">view</span> <span class="nl">setContentCompressionResistancePriority</span><span class="p">:</span><span class="mf">998.f</span> <span class="nl">forAxis</span><span class="p">:</span><span class="n">UILayoutConstraintAxisVertical</span><span class="p">];</span>
        <span class="p">[</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">view</span><span class="p">];</span>
    <span class="p">}</span>
	
	
	<span class="c1">/// 创建顶部视图
</span><span class="c1"></span>    <span class="n">UIView</span> <span class="o">*</span><span class="n">topSpacer</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIView</span> <span class="n">new</span><span class="p">];</span>
    
    <span class="c1">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO
</span><span class="c1"></span>    <span class="n">topSpacer</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">topSpacer</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">[</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">topSpacer</span><span class="p">];</span>
    <span class="n">_topSpacer</span> <span class="o">=</span> <span class="n">topSpacer</span><span class="p">;</span>
	
	<span class="c1">/// 创建底部视图
</span><span class="c1"></span>    <span class="n">UIView</span> <span class="o">*</span><span class="n">bottomSpacer</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIView</span> <span class="n">new</span><span class="p">];</span>
    
        <span class="c1">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO
</span><span class="c1"></span>    <span class="n">bottomSpacer</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="n">bottomSpacer</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">[</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">bottomSpacer</span><span class="p">];</span>
    <span class="n">_bottomSpacer</span> <span class="o">=</span> <span class="n">bottomSpacer</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">updateIndicators</span> <span class="p">{</span>
    <span class="n">UIView</span> <span class="o">*</span><span class="n">indicator</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">indicator</span><span class="p">;</span>
    
    <span class="c1">/// 判断当前指示器是否是 UIActivityIndicatorView
</span><span class="c1"></span>    <span class="kt">BOOL</span> <span class="n">isActivityIndicator</span> <span class="o">=</span> <span class="p">[</span><span class="n">indicator</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="n">UIActivityIndicatorView</span> <span class="k">class</span><span class="p">]];</span>
    
    <span class="c1">/// 判断当前指示器是否是 MBRoundProgressView
</span><span class="c1"></span>    <span class="kt">BOOL</span> <span class="n">isRoundIndicator</span> <span class="o">=</span> <span class="p">[</span><span class="n">indicator</span> <span class="nl">isKindOfClass</span><span class="p">:[</span><span class="n">MBRoundProgressView</span> <span class="k">class</span><span class="p">]];</span>

    <span class="n">MBProgressHUDMode</span> <span class="n">mode</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
    <span class="c1">/// MBProgressHUDModeIndeterminate:系统自带的指示器
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeIndeterminate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isActivityIndicator</span><span class="p">)</span> <span class="p">{</span>
             <span class="c1">// 如果当前指示器不属于 UIActivityIndicatorView 类型，则移除之前的indicator，重新创建
</span><span class="c1"></span>            <span class="p">[</span><span class="n">indicator</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIActivityIndicatorView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithActivityIndicatorStyle</span><span class="p">:</span><span class="n">UIActivityIndicatorViewStyleWhiteLarge</span><span class="p">];</span>
            <span class="p">[(</span><span class="n">UIActivityIndicatorView</span> <span class="o">*</span><span class="p">)</span><span class="n">indicator</span> <span class="n">startAnimating</span><span class="p">];</span>
            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">indicator</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeDeterminateHorizontalBar</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 如果当前指示器不属于 MBBarProgressView 类型，则移除之前的indicator，重新创建
</span><span class="c1"></span>        <span class="p">[</span><span class="n">indicator</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MBBarProgressView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">indicator</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeDeterminate</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeAnnularDeterminate</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isRoundIndicator</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">/// 如果当前指示器不属于 MBRoundProgressView 类型，则移除之前的indicator，重新创建
</span><span class="c1"></span>            <span class="p">[</span><span class="n">indicator</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
            <span class="n">indicator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MBRoundProgressView</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">indicator</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeAnnularDeterminate</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// 圆环指示器
</span><span class="c1"></span>            <span class="p">[(</span><span class="n">MBRoundProgressView</span> <span class="o">*</span><span class="p">)</span><span class="n">indicator</span> <span class="nl">setAnnular</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeCustomView</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="n">customView</span> <span class="o">!=</span> <span class="n">indicator</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// 自定义视图指示器
</span><span class="c1"></span>        <span class="p">[</span><span class="n">indicator</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">customView</span><span class="p">;</span>
        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span> <span class="nl">addSubview</span><span class="p">:</span><span class="n">indicator</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MBProgressHUDModeText</span><span class="p">)</span> <span class="p">{</span> <span class="c1">/// 文本形式，去除指示器视图
</span><span class="c1"></span>        <span class="p">[</span><span class="n">indicator</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
        <span class="n">indicator</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
        <span class="c1">/// 代码层面使用 Autolayout，需要对使用的 View 的translatesAutoresizingMaskIntoConstraints 属性设置为NO
</span><span class="c1"></span>    <span class="n">indicator</span><span class="p">.</span><span class="n">translatesAutoresizingMaskIntoConstraints</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">indicator</span> <span class="o">=</span> <span class="n">indicator</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">([</span><span class="n">indicator</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">setProgress</span><span class="p">:)])</span> <span class="p">{</span>
    	<span class="c1">/// 设置进度条的数值
</span><span class="c1"></span>        <span class="p">[(</span><span class="kt">id</span><span class="p">)</span><span class="n">indicator</span> <span class="nl">setValue</span><span class="p">:</span><span class="l">@(</span><span class="nb">self</span><span class="p">.</span><span class="n">progress</span><span class="l">)</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&#34;progress&#34;</span><span class="p">];</span>
    <span class="p">}</span>
	
	
	 <span class="c1">/// 为视图设置水平方向上优先级为 998 的压缩阻力
</span><span class="c1"></span>    <span class="p">[</span><span class="n">indicator</span> <span class="nl">setContentCompressionResistancePriority</span><span class="p">:</span><span class="mf">998.f</span> <span class="nl">forAxis</span><span class="p">:</span><span class="n">UILayoutConstraintAxisHorizontal</span><span class="p">];</span>
    
    <span class="c1">/// 为视图设置垂直方向上优先级为 998 的压缩阻力
</span><span class="c1"></span>    <span class="p">[</span><span class="n">indicator</span> <span class="nl">setContentCompressionResistancePriority</span><span class="p">:</span><span class="mf">998.f</span> <span class="nl">forAxis</span><span class="p">:</span><span class="n">UILayoutConstraintAxisVertical</span><span class="p">];</span>
	
	<span class="c1">/// 设置控件颜色
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="nl">updateViewsForColor</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">contentColor</span><span class="p">];</span>
    <span class="c1">/// 更新布局
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="n">setNeedsUpdateConstraints</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">registerForNotifications</span> <span class="p">{</span>
<span class="cp">#if !TARGET_OS_TV
</span><span class="cp"></span>    <span class="n">NSNotificationCenter</span> <span class="o">*</span><span class="n">nc</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">];</span>
	<span class="c1">/// 通过通知 UIApplicationDidChangeStatusBarOrientationNotification 来处理屏幕转屏事件
</span><span class="c1"></span>    <span class="p">[</span><span class="n">nc</span> <span class="nl">addObserver</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">statusBarOrientationDidChange</span><span class="p">:)</span>
               <span class="nl">name</span><span class="p">:</span><span class="n">UIApplicationDidChangeStatusBarOrientationNotification</span> <span class="nl">object</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="cp">#endif
</span><span class="cp"></span><span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>由上面代码我们可以看出，在方法<code>- (void)setupViews</code>中，创建了 backgroundView、bezelView、label、detailsLabel、button 这几个控件，并使用 for 循环把 label、detailsLabel、button 添加到bezelView 视图中，最后还创建了顶部视图和底部视图，不过默认是隐藏的。有一点值得说明，在创建 button 时并没有设置 button 的 size 等属性，那么这个按钮是不会显示的。在这里 MBProgressHUD 重写了一个 Unbutton 的子类 MBProgressHUDRoundedButton。这个子类里面有一个方法，<code>- (CGSize)intrinsicContentSize</code>，通过这个方法来设置 Unbutton 的 size。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="n">CGSize</span><span class="p">)</span><span class="nf">intrinsicContentSize</span> <span class="p">{</span>
    <span class="c1">/// 只有当有事件才显示（这里也告诉我们，如果这个 button 没有任何事件的话，它的大小就是 CGSizeZero，即不会显示）
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">allControlEvents</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">CGSizeZero</span><span class="p">;</span>
    <span class="n">CGSize</span> <span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">intrinsicContentSize</span><span class="p">];</span>
    <span class="c1">// Add some side padding
</span><span class="c1"></span>    <span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">+=</span> <span class="mf">20.f</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><code>- (void)updateIndicators</code>这个方法主要是用来设置 indicator 指示器的，根据 mode 的属性显示不同的形式，具体可以参看代码注释。这个方法最后调用的是<code>setNeedsUpdateConstraints</code>函数，这个函数是系统自带的方法，它会自动调用<code>- (void)updateConstraints </code> 方法，<code>- (void)updateConstraints </code> 主要作用是更新各个控件的布局，我们稍后再对这个方法进行详细分析。</p>
</li>
<li>
<p><code>- (void)registerForNotifications</code>这个方法中的代码量很少，它的作用是通过通知 UIApplicationDidChangeStatusBarOrientationNotification 来处理屏幕转屏事件</p>
</li>
</ul>
<p>当<code>- (void)registerForNotifications</code>这一系列方法执行完毕之后，程序会重新返回到<code>+ (instancetype)showHUDAddedTo:(UIView *)view animated:(BOOL)animated</code>这个方法中，接着调用另一个主要函数<code>- (void)showAnimated:(BOOL)animated</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
	
	<span class="c1">/// 显示放在主线程中
</span><span class="c1"></span>    <span class="n">MBMainThreadAssert</span><span class="p">();</span>
    
    <span class="c1">/// 取消定时器
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">minShowTimer</span> <span class="n">invalidate</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span> <span class="o">=</span> <span class="n">animated</span><span class="p">;</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    
    <span class="c1">/// 如果设置了宽限时间graceTime，则延迟显示（避免 HUD 一闪而过的差体验）
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">graceTime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    
    	<span class="c1">/// 创建定时器，把它加入 NSRunLoop 中 
</span><span class="c1"></span>        <span class="n">NSTimer</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nl">timerWithTimeInterval</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">graceTime</span> <span class="nl">target</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">handleGraceTimer</span><span class="p">:)</span> <span class="nl">userInfo</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">repeats</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
        <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="n">currentRunLoop</span><span class="p">]</span> <span class="nl">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nl">forMode</span><span class="p">:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">graceTimer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
    <span class="p">}</span> 
    
    <span class="c1">/// 没有设置 graceTime，则直接显示
</span><span class="c1"></span>    <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">showUsingAnimation</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// 设置宽限时间 graceTime时调用的方法
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">handleGraceTimer:</span><span class="p">(</span><span class="n">NSTimer</span> <span class="o">*</span><span class="p">)</span><span class="nv">theTimer</span> <span class="p">{</span>
    <span class="c1">// Show the HUD only if the task is still running
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">.</span><span class="n">hasFinished</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">showUsingAnimation</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">showUsingAnimation:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
    <span class="c1">/// 移除所有动画
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span><span class="p">.</span><span class="n">layer</span> <span class="n">removeAllAnimations</span><span class="p">];</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">backgroundView</span><span class="p">.</span><span class="n">layer</span> <span class="n">removeAllAnimations</span><span class="p">];</span>

    <span class="c1">/// 取消 hideDelayTimer
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">hideDelayTimer</span> <span class="n">invalidate</span><span class="p">];</span>

    <span class="c1">/// 开始时间
</span><span class="c1"></span>    <span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.f</span><span class="p">;</span>

    <span class="c1">/// 以防我们隐藏 NSProgress 对象
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="nl">setNSProgressDisplayLinkEnabled</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">animated</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">animateIn</span><span class="p">:</span><span class="nb">YES</span> <span class="nl">withType</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">animationType</span> <span class="nl">completion</span><span class="p">:</span><span class="nb">NULL</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">/// 方法弃用告警
</span><span class="c1"></span><span class="cp">#pragma clang diagnostic push
</span><span class="cp">#pragma clang diagnostic ignored &#34;-Wdeprecated-declarations&#34;
</span><span class="cp"></span>        <span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">opacity</span><span class="p">;</span>
<span class="cp">#pragma clang diagnostic pop
</span><span class="cp"></span>        <span class="nb">self</span><span class="p">.</span><span class="n">backgroundView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.f</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由上面这段代码我们可以看出，在方法<code>- (void)showAnimated:(BOOL)animated</code>中，无论我们有没有设置<code>graceTime</code>这个属性，最后都会去执行一个方法 <code>- (void)showUsingAnimation:(BOOL)animated </code>，<code>- (void)showUsingAnimation:(BOOL)animated </code> 这个方法在上面已经做过注释，不再细说，不过有两小点值得我们注意，第一点是 <code>- (void)showUsingAnimation:(BOOL)animated </code> 在执行过程中调用了一个方法 <code>- (void)setNSProgressDisplayLinkEnabled:(BOOL)enabled</code>，先来看下这个方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNSProgressDisplayLinkEnabled:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">enabled</span> <span class="p">{</span>
    
    <span class="c1">/// 这里使用 CADisplayLink，是因为如果使用 KVO 机制会非常消耗主线程（因为 NSProgress 频率非常快）
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="n">progressObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 创建 CADisplayLink 对象
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span> <span class="o">=</span> <span class="p">[</span><span class="n">CADisplayLink</span> <span class="nl">displayLinkWithTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateProgressFromProgressObject</span><span class="p">)];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法是关于 <code>CADisplayLink</code> 的，<code>CADisplayLink</code> 是一个能让我们以和屏幕刷新率相同的频率将内容画到屏幕上的定时器。我们在应用中创建一个新的 <code>CADisplayLink</code> 对象，把它添加到一个<code>runloop</code> 中，并给它提供一个 <code>target</code> 和 <code>selector</code> 在屏幕刷新的时候调用。一旦 <code>CADisplayLink</code> 以特定的模式注册到 <code>runloop</code> 之后，每当屏幕需要刷新，<code>runloop</code> 就会向 <code>CADisplayLink</code> 指定的<code> target</code> 发送一次指定的 <code>selector</code> 消息， <code>CADisplayLink</code> 类对应的 <code>selector</code> 就会被调用一次。</p>
<p><code>- (void)showUsingAnimation:(BOOL)animated</code> 这个方法中还有一点值得注意，就是只有具有动画效果的前提下，即 <code>animated</code> 为真时才会调用 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，下面我们再一起来看下这个方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// animated 为真时调用，消失或出现时的伸缩效果，以及透明度
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">animateIn:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animatingIn</span> <span class="nf">withType:</span><span class="p">(</span><span class="n">MBProgressHUDAnimation</span><span class="p">)</span><span class="nv">type</span> <span class="nf">completion:</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">BOOL</span> <span class="n">finished</span><span class="p">))</span><span class="nv">completion</span> <span class="p">{</span>
    <span class="c1">/// 自动确定正确的缩放动画类型，关于 MBProgressHUDAnimation 的几种类型，上文已全部列出，这里不再详细介绍
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="nl">MBProgressHUDAnimationZoomIn</span> <span class="p">:</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">/// CGAffineTransformMakeScale 中的两个参数，分别代表x和y方向缩放倍数
</span><span class="c1"></span>    <span class="n">CGAffineTransform</span> <span class="n">small</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mf">0.5f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">);</span>
    <span class="n">CGAffineTransform</span> <span class="n">large</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mf">1.5f</span><span class="p">,</span> <span class="mf">1.5f</span><span class="p">);</span>

    <span class="c1">/// 设定初始状态
</span><span class="c1"></span>    <span class="n">UIView</span> <span class="o">*</span><span class="n">bezelView</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.f</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomIn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">small</span><span class="p">;</span> <span class="c1">/// 缩放
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.f</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">large</span><span class="p">;</span> <span class="c1">/// 扩大
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">/// 创建动画任务
</span><span class="c1"></span>    <span class="n">dispatch_block_t</span> <span class="n">animations</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformIdentity</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomIn</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">large</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">small</span><span class="p">;</span>
        <span class="p">}</span>
        
    <span class="c1">/// 方法弃用告警
</span><span class="c1"></span><span class="cp">#pragma clang diagnostic push
</span><span class="cp">#pragma clang diagnostic ignored &#34;-Wdeprecated-declarations&#34;
</span><span class="cp"></span>        <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="nb">self</span><span class="p">.</span><span class="nl">opacity</span> <span class="p">:</span> <span class="mf">0.f</span><span class="p">;</span>
<span class="cp">#pragma clang diagnostic pop
</span><span class="cp"></span>        <span class="nb">self</span><span class="p">.</span><span class="n">backgroundView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="mf">1.f</span> <span class="o">:</span> <span class="mf">0.f</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">/// 动画的两种形式，&gt;= iOS7 的是一种形式，iOS7以下是另一种
</span><span class="c1"></span><span class="cp">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV
</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">kCFCoreFoundationVersionNumber</span> <span class="o">&gt;=</span> <span class="n">kCFCoreFoundationVersionNumber_iOS_7_0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 只支持 &gt;= iOS7
</span><span class="c1"></span>        <span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration</span><span class="p">:</span><span class="mf">0.3</span> <span class="nl">delay</span><span class="p">:</span><span class="mf">0.</span> <span class="nl">usingSpringWithDamping</span><span class="p">:</span><span class="mf">1.f</span> <span class="nl">initialSpringVelocity</span><span class="p">:</span><span class="mf">0.f</span> <span class="nl">options</span><span class="p">:</span><span class="n">UIViewAnimationOptionBeginFromCurrentState</span> <span class="nl">animations</span><span class="p">:</span><span class="n">animations</span> <span class="nl">completion</span><span class="p">:</span><span class="n">completion</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>    <span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration</span><span class="p">:</span><span class="mf">0.3</span> <span class="nl">delay</span><span class="p">:</span><span class="mf">0.</span> <span class="nl">options</span><span class="p">:</span><span class="n">UIViewAnimationOptionBeginFromCurrentState</span> <span class="nl">animations</span><span class="p">:</span><span class="n">animations</span> <span class="nl">completion</span><span class="p">:</span><span class="n">completion</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，无论是处于 show 状态还是处于 hide 状态，都会调用，下边我们再一起看下 hide 系列的一些方法。</p>
<h2 id="三hide-系列方法">三、hide 系列方法</h2>
<blockquote>
<p>这一部分主要是隐藏 HUD 窗口时调用的方法及代码分析</p>
</blockquote>
<p>关于隐藏 HUD 窗口，MBProgressHUD 给我们提供的方法有以下几个：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// 找到最上层的 HUD subview 并把它隐藏，成功为YES、其他情况为 NO
</span><span class="c1"></span><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">hideHUDForView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">//隐藏HUD控件，animated控制是否显示动画。对应于- (void)showAnimated:(BOOL)animated;
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span><span class="p">;</span>

<span class="c1">//在delay时间之后隐藏HUD，animated控制显示动画与否，delay控制延迟时间
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="nf">afterDelay:</span><span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">delay</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>最常用的是后面两个： <code>- (void)hideAnimated:(BOOL)animated</code> 和  <code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code>，这两个方法的本质是相同的，不同的只是形式，也就是说这两个方法的实现流程基本上是一致的，只不过 <code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 多执行一两个方法而已。下面我们就来具体分析下 hide 系列的方法。</p>
<ul>
<li>首先还是来说说<code>+ (BOOL)hideHUDForView:(UIView *)view animated:(BOOL)animated</code>这个函数，如果调用这个方法来隐藏 HUD 窗口，那么会先调用两个方法：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">hideHUDForView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="nf">animated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
	<span class="c1">/// 获取当前 view 的最上面的 HUD
</span><span class="c1"></span>    <span class="n">MBProgressHUD</span> <span class="o">*</span><span class="n">hud</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">HUDForView</span><span class="p">:</span><span class="n">view</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hud</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
    	<span class="c1">/// 移除 HUD 窗口
</span><span class="c1"></span>        <span class="n">hud</span><span class="p">.</span><span class="n">removeFromSuperViewOnHide</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
        <span class="p">[</span><span class="n">hud</span> <span class="nl">hideAnimated</span><span class="p">:</span><span class="n">animated</span><span class="p">];</span>
        <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">+</span> <span class="p">(</span><span class="n">MBProgressHUD</span> <span class="o">*</span><span class="p">)</span><span class="nf">HUDForView:</span><span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="p">)</span><span class="nv">view</span> <span class="p">{</span>
	<span class="c1">/// NSEnumerator 是一个枚举器，依附于集合类（NSArray,NSSet,NSDictionary等），reverseObjectEnumerator 倒序遍历
</span><span class="c1"></span>    <span class="n">NSEnumerator</span> <span class="o">*</span><span class="n">subviewsEnum</span> <span class="o">=</span> <span class="p">[</span><span class="n">view</span><span class="p">.</span><span class="n">subviews</span> <span class="n">reverseObjectEnumerator</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">UIView</span> <span class="o">*</span><span class="n">subview</span> <span class="k">in</span> <span class="n">subviewsEnum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">([</span><span class="n">subview</span> <span class="nl">isKindOfClass</span><span class="p">:</span><span class="nb">self</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">MBProgressHUD</span> <span class="o">*</span><span class="p">)</span><span class="n">subview</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>当执行完上面这两个方法之后，接下来执行的方法和调用<code>- (void)hideAnimated:(BOOL)animated</code>隐藏 HUD 窗口时执行的方法相同，所以下边会详细分析。</p>
<ul>
<li>接下来说说调用<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 隐藏 HUD 窗口时的情况，上文已经说过，调用这个方法会比调用<code>- (void)hideAnimated:(BOOL)animated</code> 多执行一两个方法：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="nf">afterDelay:</span><span class="p">(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">delay</span> <span class="p">{</span>
    <span class="c1">/// 创建定时器，并把它加入到 NSRunLoop 中
</span><span class="c1"></span>    <span class="n">NSTimer</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nl">timerWithTimeInterval</span><span class="p">:</span><span class="n">delay</span> <span class="nl">target</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">handleHideTimer</span><span class="p">:)</span> <span class="nl">userInfo</span><span class="p">:</span><span class="l">@(</span><span class="n">animated</span><span class="l">)</span> <span class="nl">repeats</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="n">currentRunLoop</span><span class="p">]</span> <span class="nl">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nl">forMode</span><span class="p">:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">hideDelayTimer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">handleHideTimer:</span><span class="p">(</span><span class="n">NSTimer</span> <span class="o">*</span><span class="p">)</span><span class="nv">timer</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">hideAnimated</span><span class="p">:[</span><span class="n">timer</span><span class="p">.</span><span class="n">userInfo</span> <span class="n">boolValue</span><span class="p">]];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由上面代码可以清晰的看出，<code>- (void)hideAnimated:(BOOL)animated afterDelay:(NSTimeInterval)delay</code> 这个方法中加了一个定时器，当执行完这个定时器的<code>selector</code>时，就会执行<code>- (void)hideAnimated:(BOOL)animated</code>方法。</p>
<ul>
<li>由此可见无论使用哪种方法隐藏 HUD 窗口，最终都会来到这个方法，<code>- (void)hideAnimated:(BOOL)animated</code>，接下来我们就来分析下这个方法的具体调用流程，先看个图：</li>
</ul>
<p><img src="/image/iOS/iOS_MBProgressHUD/HUD12.png" alt="hide 相关的方法调用"></p>
<p>上图显示的是 hide 相关的方法调用，只罗列了几个主要方法。接下来我们就来分析下这几个主要方法。先来到<code>- (void)hideAnimated:(BOOL)animated</code>方法中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideAnimated:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
    <span class="n">MBMainThreadAssert</span><span class="p">();</span>
    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">graceTimer</span> <span class="n">invalidate</span><span class="p">];</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span> <span class="o">=</span> <span class="n">animated</span><span class="p">;</span>
    <span class="nb">self</span><span class="p">.</span><span class="n">finished</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    
    <span class="c1">/// 如果设置了最小显示时间，则执行此步骤，否则直接隐藏
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">minShowTime</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSTimeInterval</span> <span class="n">interv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">]</span> <span class="nl">timeIntervalSinceDate</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span><span class="p">];</span>
        
        <span class="c1">/// 如果 minShowTime 比较大，则暂时不触发 HUD 的隐藏，而是启动一个 NSTimer
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">interv</span> <span class="o">&lt;</span> <span class="nb">self</span><span class="p">.</span><span class="n">minShowTime</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">/// 创建定时器，并把它加入到 NSRunLoop 中
</span><span class="c1"></span>            <span class="n">NSTimer</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nl">timerWithTimeInterval</span><span class="p">:(</span><span class="nb">self</span><span class="p">.</span><span class="n">minShowTime</span> <span class="o">-</span> <span class="n">interv</span><span class="p">)</span> <span class="nl">target</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">handleMinShowTimer</span><span class="p">:)</span> <span class="nl">userInfo</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">repeats</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
            <span class="p">[[</span><span class="n">NSRunLoop</span> <span class="n">currentRunLoop</span><span class="p">]</span> <span class="nl">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nl">forMode</span><span class="p">:</span><span class="n">NSRunLoopCommonModes</span><span class="p">];</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">minShowTimer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> 
    <span class="p">}</span>
    <span class="c1">/// 直接隐藏 HUD
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="nl">hideUsingAnimation</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">handleMinShowTimer:</span><span class="p">(</span><span class="n">NSTimer</span> <span class="o">*</span><span class="p">)</span><span class="nv">theTimer</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">self</span> <span class="nl">hideUsingAnimation</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">useAnimation</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>从上面代码块中可以看出，无论我们有没有设置最小显示时间 <code>self.minShowTime</code>，都会触发 <code>- (void)hideUsingAnimation:(BOOL)animated</code> 这个方法，因此程序最后都会来到 <code>- (void)hideUsingAnimation:(BOOL)animated</code> 这个方法中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">hideUsingAnimation:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animated</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">animated</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 将 showStarted 设为 nil
</span><span class="c1"></span>        <span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">animateIn</span><span class="p">:</span><span class="nb">NO</span> <span class="nl">withType</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">animationType</span> <span class="nl">completion</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span> <span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">[</span><span class="nb">self</span> <span class="n">done</span><span class="p">];</span>
        <span class="p">}];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">showStarted</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">backgroundView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.f</span><span class="p">;</span>
        <span class="p">[</span><span class="nb">self</span> <span class="n">done</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法和 show 系列的 <code>- (void)showUsingAnimation:(BOOL)animated</code> 方法一样，只要设定 animated 的属性为 YES，最终都会走到 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法中，同时会执行一个方法：<code>- (void)done</code>，接下来我们来看一下这两个方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="c1">/// animated 为真时调用，消失或出现时的伸缩效果，以及透明度
</span><span class="c1"></span><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">animateIn:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">animatingIn</span> <span class="nf">withType:</span><span class="p">(</span><span class="n">MBProgressHUDAnimation</span><span class="p">)</span><span class="nv">type</span> <span class="nf">completion:</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">BOOL</span> <span class="n">finished</span><span class="p">))</span><span class="nv">completion</span> <span class="p">{</span>
    <span class="c1">/// 自动确定正确的缩放动画类型，关于 MBProgressHUDAnimation 的几种类型，上文已全部列出，这里不再详细介绍
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">type</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="nl">MBProgressHUDAnimationZoomIn</span> <span class="p">:</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">/// CGAffineTransformMakeScale 中的两个参数，分别代表x和y方向缩放倍数
</span><span class="c1"></span>    <span class="n">CGAffineTransform</span> <span class="n">small</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mf">0.5f</span><span class="p">,</span> <span class="mf">0.5f</span><span class="p">);</span>
    <span class="n">CGAffineTransform</span> <span class="n">large</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeScale</span><span class="p">(</span><span class="mf">1.5f</span><span class="p">,</span> <span class="mf">1.5f</span><span class="p">);</span>

    <span class="c1">/// 设定初始状态
</span><span class="c1"></span>    <span class="n">UIView</span> <span class="o">*</span><span class="n">bezelView</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">bezelView</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.f</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomIn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">small</span><span class="p">;</span> <span class="c1">/// 缩放
</span><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.f</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">large</span><span class="p">;</span> <span class="c1">/// 扩大
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">/// 创建动画任务
</span><span class="c1"></span>    <span class="n">dispatch_block_t</span> <span class="n">animations</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">animatingIn</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformIdentity</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomIn</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">large</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">animatingIn</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">MBProgressHUDAnimationZoomOut</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bezelView</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">small</span><span class="p">;</span>
        <span class="p">}</span>
        
    <span class="c1">/// 方法弃用告警
</span><span class="c1"></span><span class="cp">#pragma clang diagnostic push
</span><span class="cp">#pragma clang diagnostic ignored &#34;-Wdeprecated-declarations&#34;
</span><span class="cp"></span>        <span class="n">bezelView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="nb">self</span><span class="p">.</span><span class="nl">opacity</span> <span class="p">:</span> <span class="mf">0.f</span><span class="p">;</span>
<span class="cp">#pragma clang diagnostic pop
</span><span class="cp"></span>        <span class="nb">self</span><span class="p">.</span><span class="n">backgroundView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">animatingIn</span> <span class="o">?</span> <span class="mf">1.f</span> <span class="o">:</span> <span class="mf">0.f</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">/// 动画的两种形式，&gt;= iOS7 的是一种形式，iOS7以下是另一种
</span><span class="c1"></span><span class="cp">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000 || TARGET_OS_TV
</span><span class="cp"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">kCFCoreFoundationVersionNumber</span> <span class="o">&gt;=</span> <span class="n">kCFCoreFoundationVersionNumber_iOS_7_0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 只支持 &gt;= iOS7
</span><span class="c1"></span>        <span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration</span><span class="p">:</span><span class="mf">0.3</span> <span class="nl">delay</span><span class="p">:</span><span class="mf">0.</span> <span class="nl">usingSpringWithDamping</span><span class="p">:</span><span class="mf">1.f</span> <span class="nl">initialSpringVelocity</span><span class="p">:</span><span class="mf">0.f</span> <span class="nl">options</span><span class="p">:</span><span class="n">UIViewAnimationOptionBeginFromCurrentState</span> <span class="nl">animations</span><span class="p">:</span><span class="n">animations</span> <span class="nl">completion</span><span class="p">:</span><span class="n">completion</span><span class="p">];</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>    <span class="p">[</span><span class="n">UIView</span> <span class="nl">animateWithDuration</span><span class="p">:</span><span class="mf">0.3</span> <span class="nl">delay</span><span class="p">:</span><span class="mf">0.</span> <span class="nl">options</span><span class="p">:</span><span class="n">UIViewAnimationOptionBeginFromCurrentState</span> <span class="nl">animations</span><span class="p">:</span><span class="n">animations</span> <span class="nl">completion</span><span class="p">:</span><span class="n">completion</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">done</span> <span class="p">{</span>
    <span class="c1">/// 取消 hideDelayTimer
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">hideDelayTimer</span> <span class="n">invalidate</span><span class="p">];</span>
    <span class="c1">/// 隐藏 NSProgress 对象
</span><span class="c1"></span>    <span class="p">[</span><span class="nb">self</span> <span class="nl">setNSProgressDisplayLinkEnabled</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">hasFinished</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">removeFromSuperViewOnHide</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">/// 从父视图中移除
</span><span class="c1"></span>            <span class="p">[</span><span class="nb">self</span> <span class="n">removeFromSuperview</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">MBProgressHUDCompletionBlock</span> <span class="n">completionBlock</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">completionBlock</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">completionBlock</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">completionBlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">id</span><span class="o">&lt;</span><span class="n">MBProgressHUDDelegate</span><span class="o">&gt;</span> <span class="n">delegate</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">delegate</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">delegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">hudWasHidden</span><span class="p">:)])</span> <span class="p">{</span>
        <span class="p">[</span><span class="n">delegate</span> <span class="nl">performSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">hudWasHidden</span><span class="p">:)</span> <span class="nl">withObject</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>关于 <code>- (void)animateIn:(BOOL)animatingIn withType:(MBProgressHUDAnimation)type completion:(void(^)(BOOL finished))completion</code> 这个方法，只要 <code>animated</code> 的属性为 YES，都会调用；而在<code>- (void)done</code> 这个方法中，如果 removeFromSuperViewOnHide 属性为 YES，则将自己从父视图上移除；如果有 completionBlock 回调函数，则执行回调；如果实现了代理并实现了代理方法，则执行代理方法。而且我们还观察到在 hide 时，也会调用 <code>- (void)setNSProgressDisplayLinkEnabled:(BOOL)enabled</code> 方法，只是在 hide 时 enabled 为 NO。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-objc" data-lang="objc"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setNSProgressDisplayLinkEnabled:</span><span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nv">enabled</span> <span class="p">{</span>
    
    <span class="c1">/// 这里使用 CADisplayLink，是因为如果使用 KVO 机制会非常消耗主线程（因为 NSProgress 频率非常快）
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="nb">self</span><span class="p">.</span><span class="n">progressObject</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">/// 创建 CADisplayLink 对象
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span> <span class="o">=</span> <span class="p">[</span><span class="n">CADisplayLink</span> <span class="nl">displayLinkWithTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">updateProgressFromProgressObject</span><span class="p">)];</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">self</span><span class="p">.</span><span class="n">progressObjectDisplayLink</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>over</strong>
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<hr>
<p>以上便是对 MBProgressHUD 源码的一些总结和认识，如果有不足之处，还希望各位道友能多指点哈！</p>
<hr>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">liupengkun</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2017-12-22
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://liupengkun1993.github.io/tags/ios/">iOS</a>
          <a href="http://liupengkun1993.github.io/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/">源码解析</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/ios/ios%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7-uiviewcontroller-%E5%9F%BA%E7%B1%BB%E8%AE%BE%E8%AE%A1/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">iOS开发技巧 - UIViewController 基类设计</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/ios/ios%E5%BC%80%E5%8F%91%E4%B9%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-masonry/">
            <span class="next-text nav-default">iOS开发之源码解析 - Masonry</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:pengkun1011@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/LiuPengKun1993" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/u/3828401985?is_all=1" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/liu-peng-kun-74-8" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="http://liupengkun1993.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        liupengkun
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
